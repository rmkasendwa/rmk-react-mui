import{j as s}from"./jsx-runtime-DoEZbXM1.js";import{C as St}from"./Close-BjwsHb0e.js";import{g as Ne,b as me,T as ge,E as Pt,i as He,P as Ct,M as Dt,c as ze}from"./SearchSyncToolbar-BD-kT8Me.js";import{c as Rt,a as Et,e as jt,f as Tt,g as qt}from"./defaultTheme-p7chgXuo.js";import{p as Wt}from"./pick-C_OPzzj8.js";import{r}from"./index-DyFhm7NF.js";import{u as Ft}from"./index-0hP6KIaD.js";import{o as Ke}from"./index-Bf2qc8Rt.js";import{u as At,L as Lt}from"./LoadingContext-BtWGSAhI.js";import"./APIContext-CE3_laQ6.js";import{u as Mt}from"./CacheableData-CKA8kD66.js";import{S as $e}from"./ErrorAlert-McfmoKYJ.js";import{T as Vt,P as kt}from"./Tooltip-DvI5SBDW.js";import{u as It}from"./useThemeProps-Bd4KMueQ.js";import{u as Bt}from"./useTheme-3fQBR54N.js";import{u as Nt}from"./dates-CvympFuk.js";import{C as Ht,c as zt}from"./Chip-Di80TdUA.js";import{T as Kt}from"./Typography-CgOnAQvQ.js";import{B as L}from"./Box-Cv6nAA57.js";import{I as $t}from"./IconButton-A2NwtEd5.js";import{G as Gt}from"./Grow-CmgiTL0Y.js";import{C as Jt}from"./ClickAwayListener-C4Bzfge9.js";const Ut=se=>qt("MuiDataDropdownField",se),Ge={root:["root"],selectedOptionsWrapper:["selectedOptionsWrapper"]},xr=Tt("MuiDataDropdownField",Object.keys(Ge)),_t=(se,he)=>{const Je=It({props:se,name:"MuiDataDropdownField"}),{className:ye,SelectProps:ie,name:N,id:H,value:c,options:D,defaultOptions:M,sortOptions:we,onChange:xe,onFocus:R,onBlur:z,InputProps:Ue={},dropdownListMaxHeight:ve,optionPaging:_e=!0,selectedOption:g,onChangeSearchTerm:E,optionVariant:Qe,sx:oe,SelectedOptionPillProps:Xe={},PaginatedDropdownOptionListProps:Ye={},WrapperProps:Ze={},disabled:V,showClearButton:Oe=!0,searchable:b=!0,getDropdownOptions:K,revalidationKey:ae,noOptionsText:et,onSelectOption:$,variant:le,label:S,limit:tt,externallyPaginated:rt,getSelectedOptions:k,startAdornment:be,endAdornment:nt,showDropdownIcon:st=!0,enableLoadingState:G=!0,showRichTextValue:Se=!0,placeholderOption:j,onChangeSelectedOptions:Pe,onChangeSelectedOption:Ce,multiple:it,selectedOptionRevalidationKey:ot,enableAddNewOption:De=!1,showNoOptionsFoundMessage:at,filterOptionBySearchTerm:lt,...u}=Je,P=Rt(Ge,Ut,(()=>{if(ye)return{root:ye}})()),J=le==="text",h=(()=>{if(le!=="text")return le})(),{sx:ut,...pt}=Xe,{...ct}=Ye,{sx:dt,...ft}=Ze,{sx:mt,...gt}=Ue,d=it||(ie==null?void 0:ie.multiple),{palette:ht,breakpoints:yt}=Bt(),T=Nt(yt.down("sm")),[I,ue]=r.useState(()=>D||[]),[wt,Re]=r.useState(1),y=r.useRef(null),C=r.useRef(null),U=r.useRef(null),Ee=r.useRef(void 0),_=r.useRef(xe);_.current=xe;const je=r.useRef(D);je.current=D;const Te=r.useRef(I);Te.current=I;const qe=r.useRef(M);qe.current=M;const pe=r.useRef(g);pe.current=g;const xt=r.useRef(k);xt.current=k;const vt=r.useRef(c);vt.current=c;const q=c!=null?JSON.stringify(c):c,[f,W]=r.useState(""),[ce,w]=r.useState(!1),[x,Q]=r.useState(!1),[B,Ot]=r.useState(null),[X,We]=r.useState([]),Y=r.useRef(Pe);Y.current=Pe;const Z=r.useRef(Ce);Z.current=Ce;const[p,v]=r.useState(()=>{const e=c?[...Array.isArray(c)?c:[c]]:[],t=e.map(i=>[...X,...M||[],...I].find(({value:o})=>i===o)).filter(i=>i),n=t.map(({value:i})=>i);return e.every(i=>n.includes(i))?t:[]}),de=r.useMemo(()=>[...X,...I],[X,I]);r.useEffect(()=>{var e,t;d?(e=Y.current)==null||e.call(Y,p):(t=Z.current)==null||t.call(Z,p[0])},[d,p]);const Fe=r.useMemo(()=>{var e;return d?p.map(({value:t})=>t):(e=p[0])==null?void 0:e.value},[d,p]),Ae=!!(k||K),{load:Le,loading:ee,loaded:Me,errorMessage:te,reset:Ve}=Mt(async({getRequestController:e})=>{const t=c?[...Array.isArray(c)?c:[c]]:[],n=await(async()=>{if(k&&t.length>0)return k(t,{getRequestController:e,getStaleWhileRevalidate:i=>{v(i.sort(({value:o},{value:l})=>t.indexOf(String(o))-t.indexOf(String(l))))}});if(K&&t.length>0){const i=l=>{const a=Array.isArray(l)?l:l.records;return[...X,...M||[],...a].filter(({value:m})=>t.includes(String(m)))},o=await K({getStaleWhileRevalidate:l=>{v(i(l).sort(({value:a},{value:m})=>t.indexOf(String(a))-t.indexOf(String(m))))}});return i(o)}return[]})();return v(n.sort(({value:i},{value:o})=>t.indexOf(String(i))-t.indexOf(String(o)))),n},{autoSync:!1,loadOnMount:!1}),re=r.useCallback(e=>{var i;const t=(()=>{var o;return d?e.map(({value:l})=>l):(o=e[0])==null?void 0:o.value})(),n=new Event("blur",{bubbles:!0});Object.defineProperty(n,"target",{writable:!1,value:{id:H,name:N,value:t}}),(i=_.current)==null||i.call(_,n)},[d,H,N]),F=r.useMemo(()=>p.filter(({label:e,searchableLabel:t})=>typeof e=="string"||typeof t=="string").map(({label:e,searchableLabel:t})=>String(t||e)).join(", "),[p]);r.useEffect(()=>{D&&ue(e=>{const t=D;return JSON.stringify(e.map(({value:n,label:i,searchableLabel:o})=>({value:n,label:String(i),searchableLabel:o})))!==JSON.stringify(t.map(({value:n,label:i,searchableLabel:o})=>({value:n,label:String(i),searchableLabel:o})))?t:e})},[D,we]),r.useEffect(()=>{!ee&&!te&&v(e=>{const t=q!=null?JSON.parse(q):q,n=t?[...Array.isArray(t)?t:[t]]:[],i=e.map(({value:a})=>a);if(g!=null&&g.value&&pe.current){const a=[pe.current],m=a.map(({value:fe})=>fe);if(n.every(fe=>m.includes(fe)))return a}const o=n.map(a=>[...qe.current||[],...Te.current].find(({value:m})=>a===m)).filter(a=>a),l=o.map(({value:a})=>a);return n.every(a=>l.includes(a))?o:(!n.every(a=>i.includes(a))&&Ae&&n.length>0&&Le(),e)})},[te,Ae,Le,ee,g==null?void 0:g.value,ot,q]),r.useEffect(()=>{q&&Me&&Ve()},[Me,Ve,q]);const O=u.multiline&&p.length>0;r.useEffect(()=>{var e;O&&x&&((e=C.current)==null||e.focus())},[x,O]),r.useEffect(()=>{ae&&ue(je.current||[])},[ae]);const{ref:ke,inView:ne}=Ft();r.useEffect(()=>{ne||w(!1)},[x,ne]),r.useEffect(()=>{if(B){const e=new ResizeObserver(()=>{Re(Math.ceil(B.clientHeight/24))});return e.observe(B),()=>{e.unobserve(B)}}else Re(1)},[B]);const A=(()=>{const e=p.length>0?p:j?[j]:[];if(Se&&(!x||O)&&e.length>0)return s.jsx(s.Fragment,{children:d?e.map(({selectedOptionLabel:t,label:n,icon:i,value:o})=>s.jsx(Ht,{...pt,label:Ne({label:t||n,icon:i}),onDelete:()=>{v(l=>{const a=l.filter(({value:m})=>m!==o);return re(a),a})},size:"small",sx:{bgcolor:Et(ht.divider,.08),...ut,[`.${zt.deleteIcon}`]:{pointerEvents:"all"}}},o)):s.jsx(Kt,{component:"div",variant:"inherit",sx:{...(()=>{if(!J)return{fontSize:14}})()},children:Ne({label:e[0].selectedOptionLabel||e[0].label,icon:e[0].icon})})})})(),{locked:bt}=At();if(G&&bt)return s.jsx(me,{...u.FieldValueDisplayProps,label:S,value:A?s.jsx(L,{className:P.selectedOptionsWrapper,sx:{display:"flex",gap:.5,...u.multiline?{flexWrap:"wrap"}:{whiteSpace:"nowrap",overflow:"hidden"}},children:A}):F});if(c&&ee||te)return s.jsx(Lt,{value:{loading:ee,errorMessage:te},children:J?s.jsx(me,{label:S}):s.jsx(ge,{...u,label:S,variant:h,enableLoadingState:G,sx:oe})});const Ie=s.jsxs($e,{direction:"row",sx:{alignItems:"center"},children:[Oe&&p.length>0&&!V&&!x?s.jsx(Vt,{title:"Clear",children:s.jsx($t,{className:"data-dropdown-input-clear-button",onClick:e=>{e.stopPropagation(),W("");const t=[];v(t),re(t)},sx:{p:.4},children:s.jsx(St,{})})}):null,st?s.jsx(Pt,{}):null,nt]}),Be=()=>{if(De&&f.length>0){const e={label:f,value:f};We(n=>[e,...n]);const t=d?[...p,e]:[e];v(t),W(""),re(t),$==null||$(e)}};return s.jsxs(s.Fragment,{children:[J?s.jsx(me,{ref:Ke([he,y,ke]),label:S,FieldValueProps:{variant:"inherit",noWrap:!0,ContainerGridProps:{sx:{mt:0}},onClick:()=>{V||w(!0)},sx:{cursor:"pointer"}},value:s.jsxs($e,{sx:{alignItems:"center",gap:1},direction:"row",children:[be,(()=>{if(A)return s.jsx(L,{className:P.selectedOptionsWrapper,sx:{pointerEvents:"none",display:"flex",gap:.5,...u.multiline?{flexWrap:"wrap"}:{whiteSpace:"nowrap",overflow:"hidden"}},children:A});if(u.placeholder)return s.jsx(L,{sx:{opacity:.2},children:u.placeholder})})(),Ie]}),enableLoadingState:G,sx:{...Wt(oe,"width","minWidth","maxWidth"),display:"inline-block"}}):s.jsx(ge,{ref:he,onFocus:e=>{!O&&ne&&(e.preventDefault(),T||w(!0),Q(!0),R==null||R(e))},onBlur:()=>{if(!O&&ne&&(Q(!1),z)){const e=new Event("blur",{bubbles:!0});Object.defineProperty(e,"target",{writable:!1,value:{name:N,id:H,value:Fe}}),z(e)}},onChange:e=>{b&&(W(e.target.value),E==null||E(e.target.value))},onKeyDown:e=>{e.key==="Enter"&&Be()},InputProps:{endAdornment:Ie,...gt,...(()=>{const e={};return p.length>0&&(e.placeholder=""),e})(),readOnly:!b||T,onClick:()=>{var e;V||(u.multiline&&((e=C.current)==null||e.focus()),w(!0))},ref:Ke([y,ke]),sx:{...(()=>{if(u.multiline)return{alignItems:"start"}})(),...mt,...(()=>{if(b&&Se&&!x&&(F.length>0||j))return{[`&>.${He.input}`]:{color:"transparent",WebkitTextFillColor:"transparent"}}})(),...(()=>{if(O)return{[`&>.${He.input}`]:{visibility:"hidden"}}})()}},inputProps:{...(()=>{if(!O)return{ref:C}})()},value:O?F:!T&&b&&(x||ce&&F.length<=0)?f:F||(j?String(j.searchableLabel||j.label):""),className:jt(P.root),variant:h,label:S,disabled:V,startAdornment:be,enableLoadingState:G,showClearButton:!x,...u,...(()=>{if(u.multiline)return{rows:wt}})(),endChildren:(()=>{if(A)return s.jsxs(L,{className:P.selectedOptionsWrapper,ref:e=>{Ot(e)},sx:{position:"absolute",left:0,pointerEvents:"none",display:"flex",gap:.5,...u.multiline?{flexWrap:"wrap"}:{whiteSpace:"nowrap",overflow:"hidden"},...(()=>{if(V)return{opacity:.38}})(),...u.size==="medium"?h==="standard"?S?{top:21}:{top:5}:h==="filled"?{top:25}:{top:17}:h==="standard"?S?{top:19}:{top:3}:h==="filled"?{top:21}:{top:9},...h==="standard"?{pb:"5px"}:h==="filled"?{pb:"4px",pl:"12px"}:{pl:"14px",alignItems:"center"}},children:[A,(()=>{if(b&&u.multiline)return s.jsx(L,{ref:U,sx:{flex:1,minWidth:100,maxWidth:300,pointerEvents:"auto"},children:s.jsx(ge,{variant:"standard",fullWidth:!0,onFocus:e=>{e.preventDefault(),T||w(!0),Q(!0),R==null||R(e)},onBlur:()=>{if(Q(!1),z){const e=new Event("blur",{bubbles:!0});Object.defineProperty(e,"target",{writable:!1,value:{name:N,id:H,value:Fe}}),z(e)}},value:f,onChange:e=>{W(e.target.value),E==null||E(e.target.value)},onKeyDown:e=>{e.key==="Enter"&&Be()},inputProps:{ref:C},InputProps:{sx:{"&:before":{borderBottomColor:"transparent"}}},enableLoadingState:!1})})})()]})})(),WrapperProps:{...ft,sx:{width:"100%",...dt,[`&>.${P.selectedOptionsWrapper}`]:{width:"calc(100% - 40px)"},...(()=>{if(Oe)return u.multiline?{[`&>.${P.selectedOptionsWrapper}`]:{width:"calc(100% - 72px)"}}:{[`&:hover>.${P.selectedOptionsWrapper}`]:{width:"calc(100% - 72px)"}}})()}},sx:{"& .data-dropdown-input-clear-button":{visibility:"hidden"},"&:hover .data-dropdown-input-clear-button":{visibility:"visible"},...oe}}),(()=>{const e=s.jsx(Ct,{paging:_e,...ct,...(()=>{if(J)return{searchable:b??!0}})(),maxHeight:ve,...(()=>{if(T)return{searchable:b??!0,maxHeight:ve??window.innerHeight-240,sx:{border:"none"}}})(),optionVariant:Qe,multiple:d,onSelectOption:$,searchTerm:f,options:de,defaultOptions:M,selectedOptions:p,getDropdownOptions:K,revalidationKey:ae,noOptionsText:et,externallyPaginated:rt,showNoOptionsFoundMessage:at,limit:tt,sortOptions:we,filterOptionBySearchTerm:lt,keyboardFocusElement:C.current,onChangeSearchTerm:t=>{W(t)},minWidth:y.current?y.current.offsetWidth:void 0,onLoadOptions:t=>{ue(t)},onClose:()=>{w(!1)},onChangeSelectedOptions:t=>{var i,o;const n=t.filter(({value:l})=>!de.some(({value:a})=>a===l));n.length>0&&We(l=>[...n,...l]),W(""),v(t),re(t),u.multiline?(i=C.current)==null||i.focus():(o=C.current)==null||o.blur()},asyncOptionPagesMap:Ee.current,onChangeAsyncOptionPagesMap:t=>{Ee.current=t},enableAddNewOption:De&&!de.some(({label:t,searchableLabel:n})=>typeof t=="string"?t.trim().toLowerCase()===f.trim().toLowerCase():n?n.trim().toLowerCase()===f.trim().toLowerCase():!1),newOptionLabel:f});return T?s.jsx(Dt,{open:ce,onClose:()=>{w(!1)},CardProps:{sx:{maxHeight:"none"}},CardBodyProps:{sx:{p:0}},disableEscapeKeyDown:!1,disableAutoFocus:!1,showHeaderToolbar:!1,enableCloseOnBackdropClick:!0,sx:{alignItems:"center",justifyContent:"center"},children:e}):s.jsx(kt,{open:ce,anchorEl:y.current,transition:!0,placement:"bottom-start",popperOptions:{strategy:"fixed"},sx:{zIndex:9999},children:({TransitionProps:t})=>s.jsx(Gt,{...t,style:{transformOrigin:"0 0 0"},children:s.jsx(L,{children:s.jsx(Jt,{onClickAway:n=>{(y.current||U.current)&&w(!!(y.current&&ze(y.current,n.target))||!!(U.current&&ze(U.current,n.target)))},children:e})})})})})()]})},Qt=r.forwardRef(_t);Qt.__docgenInfo={description:"",methods:[],displayName:"DataDropdownField",props:{onChangeSelectedOption:{required:!1,tsType:{name:"signature",type:"function",raw:"(selectedOption?: DropdownOption<Entity>) => void",signature:{arguments:[{type:{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"},name:"selectedOption"}],return:{name:"void"}}},description:""},disableEmptyOption:{required:!1,tsType:{name:"boolean"},description:""},value:{required:!1,tsType:{name:"union",raw:"string | string[]",elements:[{name:"string"},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},description:""},selectedOption:{required:!1,tsType:{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"},description:""},placeholderOption:{required:!1,tsType:{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"},description:""},getSelectedOptions:{required:!1,tsType:{name:"signature",type:"function",raw:`(
  selectedValue: string[],
  options: CacheableDataFinderOptions
) => Promise<DropdownOption<Entity>[]>`,signature:{arguments:[{type:{name:"Array",elements:[{name:"string"}],raw:"string[]"},name:"selectedValue"},{type:{name:"signature",type:"object",raw:`{
  /**
   * Function that can be used to retrieve the request controller of the data request.
   *
   * @param controller The request controller that can be used to cancel the request.
   */
  getRequestController: (controller: RecordFinderRequestController) => void;

  /**
   * Function that can be used to retrieve stale data while the request is being made.
   */
  getStaleWhileRevalidate: GetStaleWhileRevalidateFunction<any>;
}`,signature:{properties:[{key:"getRequestController",value:{name:"signature",type:"function",raw:"(controller: RecordFinderRequestController) => void",signature:{arguments:[{type:{name:"RecordFinderRequestController"},name:"controller"}],return:{name:"void"}},required:!0},description:`Function that can be used to retrieve the request controller of the data request.

@param controller The request controller that can be used to cancel the request.`},{key:"getStaleWhileRevalidate",value:{name:"signature",type:"function",raw:"(data: Data) => void",signature:{arguments:[{type:{name:"any"},name:"data"}],return:{name:"void"}},required:!0},description:"Function that can be used to retrieve stale data while the request is being made."}]}},name:"options"}],return:{name:"Promise",elements:[{name:"Array",elements:[{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"}],raw:"DropdownOption<Entity>[]"}],raw:"Promise<DropdownOption<Entity>[]>"}}},description:""},dropdownListMaxHeight:{required:!1,tsType:{name:"number"},description:""},optionPaging:{required:!1,tsType:{name:"boolean"},description:""},onChangeSearchTerm:{required:!1,tsType:{name:"signature",type:"function",raw:"(searchTerm: string) => void",signature:{arguments:[{type:{name:"string"},name:"searchTerm"}],return:{name:"void"}}},description:""},SelectedOptionPillProps:{required:!1,tsType:{name:"Partial",elements:[{name:"ChipProps"}],raw:"Partial<ChipProps>"},description:""},PaginatedDropdownOptionListProps:{required:!1,tsType:{name:"Partial",elements:[{name:"PaginatedDropdownOptionListProps"}],raw:"Partial<PaginatedDropdownOptionListProps>"},description:""},variant:{required:!1,tsType:{name:"union",raw:"'standard' | 'filled' | 'outlined' | 'text'",elements:[{name:"literal",value:"'standard'"},{name:"literal",value:"'filled'"},{name:"literal",value:"'outlined'"},{name:"literal",value:"'text'"}]},description:""},showDropdownIcon:{required:!1,tsType:{name:"boolean"},description:""},showRichTextValue:{required:!1,tsType:{name:"boolean"},description:""},selectedOptionRevalidationKey:{required:!1,tsType:{name:"string"},description:""}},composes:["Omit","Partial"]};export{Qt as D,xr as d};
