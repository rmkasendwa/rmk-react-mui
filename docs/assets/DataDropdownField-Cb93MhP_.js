import{j as i}from"./jsx-runtime-DoEZbXM1.js";import{C as Ot}from"./Close-BjwsHb0e.js";import{g as Ne,b as me,T as ge,E as bt,m as St,i as He,P as Pt,M as Ct,c as ze}from"./SearchSyncToolbar-BnnCoHC4.js";import{c as Dt,a as Rt,e as Et,f as jt,g as Tt}from"./defaultTheme-p7chgXuo.js";import{p as qt}from"./pick-BJ3H5asV.js";import{r}from"./index-DyFhm7NF.js";import{u as Wt}from"./index-0hP6KIaD.js";import{o as Ke}from"./index-Bf2qc8Rt.js";import{u as Ft,L as At}from"./LoadingContext-BtWGSAhI.js";import"./APIContext-CE3_laQ6.js";import{u as Lt}from"./CacheableData-vc3DpkOG.js";import{S as $e}from"./ErrorAlert-McfmoKYJ.js";import{T as Mt,P as Vt}from"./Tooltip-DvI5SBDW.js";import{u as kt}from"./useThemeProps-Bd4KMueQ.js";import{u as Bt}from"./useTheme-3fQBR54N.js";import{u as It}from"./dates-CvympFuk.js";import{C as Nt,c as Ht}from"./Chip-Di80TdUA.js";import{T as zt}from"./Typography-CgOnAQvQ.js";import{B as L}from"./Box-Cv6nAA57.js";import{I as Kt}from"./IconButton-A2NwtEd5.js";import{G as $t}from"./Grow-CmgiTL0Y.js";import{C as Gt}from"./ClickAwayListener-C4Bzfge9.js";const Jt=ie=>Tt("MuiDataDropdownField",ie),Ge={root:["root"],selectedOptionsWrapper:["selectedOptionsWrapper"]},wr=jt("MuiDataDropdownField",Object.keys(Ge)),Ut=(ie,he)=>{const Je=kt({props:ie,name:"MuiDataDropdownField"}),{className:ye,SelectProps:se,name:N,id:H,value:c,options:D,defaultOptions:M,sortOptions:we,onChange:ve,onFocus:R,onBlur:z,slotProps:Ue,dropdownListMaxHeight:xe,optionPaging:_e=!0,selectedOption:g,onChangeSearchTerm:E,optionVariant:Qe,sx:oe,SelectedOptionPillProps:Xe={},PaginatedDropdownOptionListProps:Ye={},WrapperProps:Ze={},disabled:V,showClearButton:Oe=!0,searchable:b=!0,getDropdownOptions:K,revalidationKey:ae,noOptionsText:et,onSelectOption:$,variant:le,label:S,limit:tt,externallyPaginated:rt,getSelectedOptions:k,startAdornment:be,endAdornment:nt,showDropdownIcon:it=!0,enableLoadingState:G=!0,showRichTextValue:Se=!0,placeholderOption:j,onChangeSelectedOptions:Pe,onChangeSelectedOption:Ce,multiple:st,selectedOptionRevalidationKey:ot,enableAddNewOption:De=!1,showNoOptionsFoundMessage:at,filterOptionBySearchTerm:lt,...u}=Je,P=Dt(Ge,Jt,(()=>{if(ye)return{root:ye}})()),J=le==="text",h=(()=>{if(le!=="text")return le})(),{sx:ut,...pt}=Xe,{...ct}=Ye,{sx:dt,...ft}=Ze,d=st||(se==null?void 0:se.multiple),{palette:mt,breakpoints:gt}=Bt(),T=It(gt.down("sm")),[B,ue]=r.useState(()=>D||[]),[ht,Re]=r.useState(1),y=r.useRef(null),C=r.useRef(null),U=r.useRef(null),Ee=r.useRef(void 0),_=r.useRef(ve);_.current=ve;const je=r.useRef(D);je.current=D;const Te=r.useRef(B);Te.current=B;const qe=r.useRef(M);qe.current=M;const pe=r.useRef(g);pe.current=g;const yt=r.useRef(k);yt.current=k;const wt=r.useRef(c);wt.current=c;const q=c!=null?JSON.stringify(c):c,[f,W]=r.useState(""),[ce,w]=r.useState(!1),[v,Q]=r.useState(!1),[I,vt]=r.useState(null),[X,We]=r.useState([]),Y=r.useRef(Pe);Y.current=Pe;const Z=r.useRef(Ce);Z.current=Ce;const[p,x]=r.useState(()=>{const e=c?[...Array.isArray(c)?c:[c]]:[],t=e.map(s=>[...X,...M||[],...B].find(({value:o})=>s===o)).filter(s=>s),n=t.map(({value:s})=>s);return e.every(s=>n.includes(s))?t:[]}),de=r.useMemo(()=>[...X,...B],[X,B]);r.useEffect(()=>{var e,t;d?(e=Y.current)==null||e.call(Y,p):(t=Z.current)==null||t.call(Z,p[0])},[d,p]);const Fe=r.useMemo(()=>{var e;return d?p.map(({value:t})=>t):(e=p[0])==null?void 0:e.value},[d,p]),Ae=!!(k||K),{load:Le,loading:ee,loaded:Me,errorMessage:te,reset:Ve}=Lt(async({getRequestController:e})=>{const t=c?[...Array.isArray(c)?c:[c]]:[],n=await(async()=>{if(k&&t.length>0)return k(t,{getRequestController:e,getStaleWhileRevalidate:s=>{x(s.sort(({value:o},{value:l})=>t.indexOf(String(o))-t.indexOf(String(l))))}});if(K&&t.length>0){const s=l=>{const a=Array.isArray(l)?l:l.records;return[...X,...M||[],...a].filter(({value:m})=>t.includes(String(m)))},o=await K({getStaleWhileRevalidate:l=>{x(s(l).sort(({value:a},{value:m})=>t.indexOf(String(a))-t.indexOf(String(m))))}});return s(o)}return[]})();return x(n.sort(({value:s},{value:o})=>t.indexOf(String(s))-t.indexOf(String(o)))),n},{autoSync:!1,loadOnMount:!1}),re=r.useCallback(e=>{var s;const t=(()=>{var o;return d?e.map(({value:l})=>l):(o=e[0])==null?void 0:o.value})(),n=new Event("blur",{bubbles:!0});Object.defineProperty(n,"target",{writable:!1,value:{id:H,name:N,value:t}}),(s=_.current)==null||s.call(_,n)},[d,H,N]),F=r.useMemo(()=>p.filter(({label:e,searchableLabel:t})=>typeof e=="string"||typeof t=="string").map(({label:e,searchableLabel:t})=>String(t||e)).join(", "),[p]);r.useEffect(()=>{D&&ue(e=>{const t=D;return JSON.stringify(e.map(({value:n,label:s,searchableLabel:o})=>({value:n,label:String(s),searchableLabel:o})))!==JSON.stringify(t.map(({value:n,label:s,searchableLabel:o})=>({value:n,label:String(s),searchableLabel:o})))?t:e})},[D,we]),r.useEffect(()=>{!ee&&!te&&x(e=>{const t=q!=null?JSON.parse(q):q,n=t?[...Array.isArray(t)?t:[t]]:[],s=e.map(({value:a})=>a);if(g!=null&&g.value&&pe.current){const a=[pe.current],m=a.map(({value:fe})=>fe);if(n.every(fe=>m.includes(fe)))return a}const o=n.map(a=>[...qe.current||[],...Te.current].find(({value:m})=>a===m)).filter(a=>a),l=o.map(({value:a})=>a);return n.every(a=>l.includes(a))?o:(!n.every(a=>s.includes(a))&&Ae&&n.length>0&&Le(),e)})},[te,Ae,Le,ee,g==null?void 0:g.value,ot,q]),r.useEffect(()=>{q&&Me&&Ve()},[Me,Ve,q]);const O=u.multiline&&p.length>0;r.useEffect(()=>{var e;O&&v&&((e=C.current)==null||e.focus())},[v,O]),r.useEffect(()=>{ae&&ue(je.current||[])},[ae]);const{ref:ke,inView:ne}=Wt();r.useEffect(()=>{ne||w(!1)},[v,ne]),r.useEffect(()=>{if(I){const e=new ResizeObserver(()=>{Re(Math.ceil(I.clientHeight/24))});return e.observe(I),()=>{e.unobserve(I)}}else Re(1)},[I]);const A=(()=>{const e=p.length>0?p:j?[j]:[];if(Se&&(!v||O)&&e.length>0)return i.jsx(i.Fragment,{children:d?e.map(({selectedOptionLabel:t,label:n,icon:s,value:o})=>i.jsx(Nt,{...pt,label:Ne({label:t||n,icon:s}),onDelete:()=>{x(l=>{const a=l.filter(({value:m})=>m!==o);return re(a),a})},size:"small",sx:{bgcolor:Rt(mt.divider,.08),...ut,[`.${Ht.deleteIcon}`]:{pointerEvents:"all"}}},o)):i.jsx(zt,{component:"div",variant:"inherit",sx:{...(()=>{if(!J)return{fontSize:14}})()},children:Ne({label:e[0].selectedOptionLabel||e[0].label,icon:e[0].icon})})})})(),{locked:xt}=Ft();if(G&&xt)return i.jsx(me,{...u.FieldValueDisplayProps,label:S,value:A?i.jsx(L,{className:P.selectedOptionsWrapper,sx:{display:"flex",gap:.5,...u.multiline?{flexWrap:"wrap"}:{whiteSpace:"nowrap",overflow:"hidden"}},children:A}):F});if(c&&ee||te)return i.jsx(At,{value:{loading:ee,errorMessage:te},children:J?i.jsx(me,{label:S}):i.jsx(ge,{...u,label:S,variant:h,enableLoadingState:G,sx:oe})});const Be=i.jsxs($e,{direction:"row",sx:{alignItems:"center"},children:[Oe&&p.length>0&&!V&&!v?i.jsx(Mt,{title:"Clear",children:i.jsx(Kt,{className:"data-dropdown-input-clear-button",onClick:e=>{e.stopPropagation(),W("");const t=[];x(t),re(t)},sx:{p:.4},children:i.jsx(Ot,{})})}):null,it?i.jsx(bt,{}):null,nt]}),Ie=()=>{if(De&&f.length>0){const e={label:f,value:f};We(n=>[e,...n]);const t=d?[...p,e]:[e];x(t),W(""),re(t),$==null||$(e)}};return i.jsxs(i.Fragment,{children:[J?i.jsx(me,{ref:Ke([he,y,ke]),label:S,FieldValueProps:{variant:"inherit",noWrap:!0,ContainerGridProps:{sx:{mt:0}},onClick:()=>{V||w(!0)},sx:{cursor:"pointer"}},value:i.jsxs($e,{sx:{alignItems:"center",gap:1},direction:"row",children:[be,(()=>{if(A)return i.jsx(L,{className:P.selectedOptionsWrapper,sx:{pointerEvents:"none",display:"flex",gap:.5,...u.multiline?{flexWrap:"wrap"}:{whiteSpace:"nowrap",overflow:"hidden"}},children:A});if(u.placeholder)return i.jsx(L,{sx:{opacity:.2},children:u.placeholder})})(),Be]}),enableLoadingState:G,sx:{...qt(oe,"width","minWidth","maxWidth"),display:"inline-block"}}):i.jsx(ge,{ref:he,onFocus:e=>{!O&&ne&&(e.preventDefault(),T||w(!0),Q(!0),R==null||R(e))},onBlur:()=>{if(!O&&ne&&(Q(!1),z)){const e=new Event("blur",{bubbles:!0});Object.defineProperty(e,"target",{writable:!1,value:{name:N,id:H,value:Fe}}),z(e)}},onChange:e=>{b&&(W(e.target.value),E==null||E(e.target.value))},onKeyDown:e=>{e.key==="Enter"&&Ie()},slotProps:St({input:{endAdornment:Be,...(()=>{const e={};return p.length>0&&(e.placeholder=""),e})(),readOnly:!b||T,onClick:()=>{var e;V||(u.multiline&&((e=C.current)==null||e.focus()),w(!0))},ref:Ke([y,ke]),sx:{...(()=>{if(u.multiline)return{alignItems:"start"}})(),...(()=>{if(b&&Se&&!v&&(F.length>0||j))return{[`&>.${He.input}`]:{color:"transparent",WebkitTextFillColor:"transparent"}}})(),...(()=>{if(O)return{[`&>.${He.input}`]:{visibility:"hidden"}}})()}},htmlInput:{...(()=>{if(!O)return{ref:C}})()}},Ue),value:O?F:!T&&b&&(v||ce&&F.length<=0)?f:F||(j?String(j.searchableLabel||j.label):""),className:Et(P.root),variant:h,label:S,disabled:V,startAdornment:be,enableLoadingState:G,showClearButton:!v,...u,...(()=>{if(u.multiline)return{rows:ht}})(),endChildren:(()=>{if(A)return i.jsxs(L,{className:P.selectedOptionsWrapper,ref:e=>{vt(e)},sx:{position:"absolute",left:0,pointerEvents:"none",display:"flex",gap:.5,...u.multiline?{flexWrap:"wrap"}:{whiteSpace:"nowrap",overflow:"hidden"},...(()=>{if(V)return{opacity:.38}})(),...u.size==="medium"?h==="standard"?S?{top:21}:{top:5}:h==="filled"?{top:25}:{top:17}:h==="standard"?S?{top:19}:{top:3}:h==="filled"?{top:21}:{top:9},...h==="standard"?{pb:"5px"}:h==="filled"?{pb:"4px",pl:"12px"}:{pl:"14px",alignItems:"center"}},children:[A,(()=>{if(b&&u.multiline)return i.jsx(L,{ref:U,sx:{flex:1,minWidth:100,maxWidth:300,pointerEvents:"auto"},children:i.jsx(ge,{variant:"standard",fullWidth:!0,onFocus:e=>{e.preventDefault(),T||w(!0),Q(!0),R==null||R(e)},onBlur:()=>{if(Q(!1),z){const e=new Event("blur",{bubbles:!0});Object.defineProperty(e,"target",{writable:!1,value:{name:N,id:H,value:Fe}}),z(e)}},value:f,onChange:e=>{W(e.target.value),E==null||E(e.target.value)},onKeyDown:e=>{e.key==="Enter"&&Ie()},slotProps:{input:{sx:{"&:before":{borderBottomColor:"transparent"}}},htmlInput:{ref:C}},enableLoadingState:!1})})})()]})})(),WrapperProps:{...ft,sx:{width:"100%",...dt,[`&>.${P.selectedOptionsWrapper}`]:{width:"calc(100% - 40px)"},...(()=>{if(Oe)return u.multiline?{[`&>.${P.selectedOptionsWrapper}`]:{width:"calc(100% - 72px)"}}:{[`&:hover>.${P.selectedOptionsWrapper}`]:{width:"calc(100% - 72px)"}}})()}},sx:{"& .data-dropdown-input-clear-button":{visibility:"hidden"},"&:hover .data-dropdown-input-clear-button":{visibility:"visible"},...oe}}),(()=>{const e=i.jsx(Pt,{paging:_e,...ct,...(()=>{if(J)return{searchable:b??!0}})(),maxHeight:xe,...(()=>{if(T)return{searchable:b??!0,maxHeight:xe??window.innerHeight-240,sx:{border:"none"}}})(),optionVariant:Qe,multiple:d,onSelectOption:$,searchTerm:f,options:de,defaultOptions:M,selectedOptions:p,getDropdownOptions:K,revalidationKey:ae,noOptionsText:et,externallyPaginated:rt,showNoOptionsFoundMessage:at,limit:tt,sortOptions:we,filterOptionBySearchTerm:lt,keyboardFocusElement:C.current,onChangeSearchTerm:t=>{W(t)},minWidth:y.current?y.current.offsetWidth:void 0,onLoadOptions:t=>{ue(t)},onClose:()=>{w(!1)},onChangeSelectedOptions:t=>{var s,o;const n=t.filter(({value:l})=>!de.some(({value:a})=>a===l));n.length>0&&We(l=>[...n,...l]),W(""),x(t),re(t),u.multiline?(s=C.current)==null||s.focus():(o=C.current)==null||o.blur()},asyncOptionPagesMap:Ee.current,onChangeAsyncOptionPagesMap:t=>{Ee.current=t},enableAddNewOption:De&&!de.some(({label:t,searchableLabel:n})=>typeof t=="string"?t.trim().toLowerCase()===f.trim().toLowerCase():n?n.trim().toLowerCase()===f.trim().toLowerCase():!1),newOptionLabel:f});return T?i.jsx(Ct,{open:ce,onClose:()=>{w(!1)},CardProps:{sx:{maxHeight:"none"}},CardBodyProps:{sx:{p:0}},disableEscapeKeyDown:!1,disableAutoFocus:!1,showHeaderToolbar:!1,enableCloseOnBackdropClick:!0,sx:{alignItems:"center",justifyContent:"center"},children:e}):i.jsx(Vt,{open:ce,anchorEl:y.current,transition:!0,placement:"bottom-start",popperOptions:{strategy:"fixed"},sx:{zIndex:9999},children:({TransitionProps:t})=>i.jsx($t,{...t,style:{transformOrigin:"0 0 0"},children:i.jsx(L,{children:i.jsx(Gt,{onClickAway:n=>{(y.current||U.current)&&w(!!(y.current&&ze(y.current,n.target))||!!(U.current&&ze(U.current,n.target)))},children:e})})})})})()]})},_t=r.forwardRef(Ut);_t.__docgenInfo={description:"",methods:[],displayName:"DataDropdownField",props:{onChangeSelectedOption:{required:!1,tsType:{name:"signature",type:"function",raw:"(selectedOption?: DropdownOption<Entity>) => void",signature:{arguments:[{type:{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"},name:"selectedOption"}],return:{name:"void"}}},description:""},disableEmptyOption:{required:!1,tsType:{name:"boolean"},description:""},value:{required:!1,tsType:{name:"union",raw:"string | string[]",elements:[{name:"string"},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},description:""},selectedOption:{required:!1,tsType:{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"},description:""},placeholderOption:{required:!1,tsType:{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"},description:""},getSelectedOptions:{required:!1,tsType:{name:"signature",type:"function",raw:`(
  selectedValue: string[],
  options: CacheableDataFinderOptions
) => Promise<DropdownOption<Entity>[]>`,signature:{arguments:[{type:{name:"Array",elements:[{name:"string"}],raw:"string[]"},name:"selectedValue"},{type:{name:"signature",type:"object",raw:`{
  /**
   * Function that can be used to retrieve the request controller of the data request.
   *
   * @param controller The request controller that can be used to cancel the request.
   */
  getRequestController: (controller: RecordFinderRequestController) => void;

  /**
   * Function that can be used to retrieve stale data while the request is being made.
   */
  getStaleWhileRevalidate: GetStaleWhileRevalidateFunction<any>;
}`,signature:{properties:[{key:"getRequestController",value:{name:"signature",type:"function",raw:"(controller: RecordFinderRequestController) => void",signature:{arguments:[{type:{name:"RecordFinderRequestController"},name:"controller"}],return:{name:"void"}},required:!0},description:`Function that can be used to retrieve the request controller of the data request.

@param controller The request controller that can be used to cancel the request.`},{key:"getStaleWhileRevalidate",value:{name:"signature",type:"function",raw:"(data: Data) => void",signature:{arguments:[{type:{name:"any"},name:"data"}],return:{name:"void"}},required:!0},description:"Function that can be used to retrieve stale data while the request is being made."}]}},name:"options"}],return:{name:"Promise",elements:[{name:"Array",elements:[{name:"DropdownOption",elements:[{name:"Entity"}],raw:"DropdownOption<Entity>"}],raw:"DropdownOption<Entity>[]"}],raw:"Promise<DropdownOption<Entity>[]>"}}},description:""},dropdownListMaxHeight:{required:!1,tsType:{name:"number"},description:""},optionPaging:{required:!1,tsType:{name:"boolean"},description:""},onChangeSearchTerm:{required:!1,tsType:{name:"signature",type:"function",raw:"(searchTerm: string) => void",signature:{arguments:[{type:{name:"string"},name:"searchTerm"}],return:{name:"void"}}},description:""},SelectedOptionPillProps:{required:!1,tsType:{name:"Partial",elements:[{name:"ChipProps"}],raw:"Partial<ChipProps>"},description:""},PaginatedDropdownOptionListProps:{required:!1,tsType:{name:"Partial",elements:[{name:"PaginatedDropdownOptionListProps"}],raw:"Partial<PaginatedDropdownOptionListProps>"},description:""},variant:{required:!1,tsType:{name:"union",raw:"'standard' | 'filled' | 'outlined' | 'text'",elements:[{name:"literal",value:"'standard'"},{name:"literal",value:"'filled'"},{name:"literal",value:"'outlined'"},{name:"literal",value:"'text'"}]},description:""},showDropdownIcon:{required:!1,tsType:{name:"boolean"},description:""},showRichTextValue:{required:!1,tsType:{name:"boolean"},description:""},selectedOptionRevalidationKey:{required:!1,tsType:{name:"string"},description:""}},composes:["Omit","Partial"]};export{_t as D,wr as d};
